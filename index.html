<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wealth Architect: Multi-Event Model</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; padding: 20px; color: #1e293b; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #fff; border-top: 4px solid #64748b; }
        .re { border-top-color: #f59e0b; } .inv { border-top-color: #10b981; }
        label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-top: 8px; }
        input { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; box-sizing: border-box; }
        .event-list { margin-top: 15px; padding: 10px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 6px; }
        .event-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: flex-end; }
        .btn-add { font-size: 10px; background: #10b981; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 3px; margin-top: 5px; }
        .btn-del { background: #ef4444; color: white; border: none; padding: 5px 8px; cursor: pointer; border-radius: 3px; }
        .btn-run { padding: 15px; background: #1e293b; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; }
        .table-wrap { overflow-x: auto; margin-top: 25px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        th { background: #f8fafc; position: sticky; top: 0; }
        .lump-hit { background: #fef3c7; font-weight: bold; color: #92400e; }
        .neg { color: #ef4444; }
        .total-col { background: #f1f5f9; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>Strategic Wealth & Smith Flywheel Engine</h2>
    <div class="grid">
        <div class="card">
            <strong>Timeline Control</strong>
            <label>Current Age</label><input type="number" id="curAge" value="40">
            <label>End Simulation Age</label><input type="number" id="tarAge" value="85">
            <button class="btn-run" onclick="runSim()">ðŸš€ Re-Calculate All Assets</button>
        </div>

        <div class="card re">
            <strong>Property & Smith Flywheel</strong>
            <label>Home Value ($)</label><input type="number" id="reVal" value="800000">
            <label>Mortgage Debt ($)</label><input type="number" id="reDebt" value="500000">
            <label>Mortgage Rate (%)</label><input type="number" id="reRate" value="5.0">
            <label>Investment Return (%)</label><input type="number" id="smRate" value="8.0">
        </div>

        <div class="card inv">
            <strong>Investment Account</strong>
            <label>Initial Balance ($)</label><input type="number" id="invBal" value="150000">
            <label>Annual Return (%)</label><input type="number" id="invRate" value="7.0">
            
            <div class="event-list" id="eventList">
                <strong>Targeted Withdrawals</strong>
                <div id="eventsContainer">
                    <div class="event-row">
                        <div><label>Age</label><input type="number" class="evAge" value="65" style="width:50px"></div>
                        <div><label>Amount ($)</label><input type="number" class="evAmt" value="50000" style="width:100px"></div>
                        <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
                    </div>
                </div>
                <button class="btn-add" onclick="addEventRow()">+ Add Withdrawal Event</button>
            </div>
        </div>
    </div>

    <div id="output" class="table-wrap"></div>
</div>

<script>
function addEventRow() {
    const container = document.getElementById('eventsContainer');
    const row = document.createElement('div');
    row.className = 'event-row';
    row.innerHTML = `
        <div><label>Age</label><input type="number" class="evAge" placeholder="60" style="width:50px"></div>
        <div><label>Amount ($)</label><input type="number" class="evAmt" placeholder="20000" style="width:100px"></div>
        <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
    `;
    container.appendChild(row);
}

function fmt(v) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v); }

function runSim() {
    const startAge = parseInt(document.getElementById('curAge').value);
    const endAge = parseInt(document.getElementById('tarAge').value);
    
    // Property/Smith Init
    let hVal = parseFloat(document.getElementById('reVal').value);
    let mDebt = parseFloat(document.getElementById('reDebt').value);
    const mRateM = (parseFloat(document.getElementById('reRate').value) / 100) / 12;
    const mPay = mDebt > 0 ? mDebt * (mRateM * Math.pow(1 + mRateM, 300)) / (Math.pow(1 + mRateM, 300) - 1) : 0;
    let sBal = 0, sDebt = 0, smReturn = parseFloat(document.getElementById('smRate').value);

    // Investment Init
    let iBal = parseFloat(document.getElementById('invBal').value);
    const iRate = parseFloat(document.getElementById('invRate').value) / 100;
    
    // Collect all custom events
    const eventRows = document.querySelectorAll('.event-row');
    let events = Array.from(eventRows).map(row => ({
        age: parseInt(row.querySelector('.evAge').value),
        amt: parseFloat(row.querySelector('.evAmt').value || 0)
    }));

    let html = `<table><thead><tr>
        <th>Age</th>
        <th>Home Value</th>
        <th>Mortgage</th>
        <th>Smith Portfolio</th>
        <th>HELOC Debt</th>
        <th>Inv. Balance</th>
        <th>Withdrawal Logic</th>
        <th>NET WORTH</th>
    </tr></thead><tbody>`;

    for (let age = startAge; age <= endAge; age++) {
        // 1. Find all withdrawals hitting this age
        let totalWithdrawal = events
            .filter(e => e.age === age)
            .reduce((sum, e) => sum + e.amt, 0);
        
        if (totalWithdrawal > iBal) totalWithdrawal = iBal;

        let nw = (hVal - mDebt) + (sBal - sDebt) + iBal;

        html += `<tr class="${totalWithdrawal > 0 ? 'lump-hit' : ''}">
            <td>${age}</td>
            <td>${fmt(hVal)}</td>
            <td class="neg">${fmt(mDebt)}</td>
            <td>${fmt(sBal)}</td>
            <td class="neg">${fmt(sDebt)}</td>
            <td>${fmt(iBal)}</td>
            <td>${totalWithdrawal > 0 ? 'WITHDREW ' + fmt(totalWithdrawal) : '-'}</td>
            <td class="total-col">${fmt(nw)}</td>
        </tr>`;

        // Advance to next year
        if (age < endAge) {
            hVal *= 1.03; 
            for (let m = 0; m < 12; m++) {
                if (mDebt > 0) {
                    let mInt = mDebt * mRateM;
                    let mPrin = Math.min(mDebt, mPay - mInt);
                    mDebt -= mPrin;
                    
                    let growth = sBal * (smReturn/1200);
                    mDebt = Math.max(0, mDebt - growth);
                    
                    let totalP = mPrin + growth;
                    sDebt += totalP;
                    sBal += totalP + (sBal * (smReturn/1200));
                } else {
                    sBal *= (1 + smReturn/1200);
                }
            }
            // Subtract withdrawal and compound investment
            iBal = (iBal - totalWithdrawal) * (1 + iRate);
            if (iBal < 0) iBal = 0;
        }
    }

    html += `</tbody></table>`;
    document.getElementById('output').innerHTML = html;
}

window.onload = runSim;
</script>
</body>
</html>
