<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Wealth Oracle: Modular Strategy Engine</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; padding: 20px; color: #1e293b; }
        .container { max-width: 1900px; margin: 0 auto; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .controls-top { display: flex; gap: 20px; background: #1e293b; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; background: #fff; position: relative; border-top: 5px solid #64748b; }
        .re-card { border-top-color: #f59e0b; } .inv-card { border-top-color: #10b981; }
        .remove-btn { position: absolute; top: 10px; right: 10px; background: #fee2e2; color: #ef4444; border: none; border-radius: 4px; cursor: pointer; padding: 2px 8px; font-weight: bold; }
        label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-top: 8px; }
        input { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; box-sizing: border-box; }
        .event-list { margin-top: 12px; padding: 10px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 6px; }
        .event-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: flex-end; }
        .btn-action { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-add { background: #10b981; color: white; }
        .btn-run { background: #3b82f6; color: white; padding: 12px 30px; font-size: 1rem; }
        .table-wrap { overflow-x: auto; margin-top: 25px; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1600px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        th { background: #f8fafc; position: sticky; top: 0; z-index: 10; }
        .lump-hit { background: #fef3c7; font-weight: bold; }
        .neg { color: #ef4444; font-weight: bold; }
        .shadow-wd { background: #ecfdf5; color: #065f46; font-weight: bold; }
        .interest-col { color: #2563eb; font-weight: 600; background: #eff6ff; }
        .total-col { background: #f1f5f9; font-weight: 900; color: #1e293b; }
    </style>
</head>
<body>

<div class="container">
    <h2>Modular Wealth Oracle <span style="font-size:0.6em; font-weight:normal; color:#64748b">| Interactive Strategy Planner</span></h2>
    
    <div class="controls-top">
        <div><label style="color:white">Current Age</label><input type="number" id="curAge" value="40" style="width:80px"></div>
        <div><label style="color:white">End Age</label><input type="number" id="tarAge" value="90" style="width:80px"></div>
        <button class="btn-action" style="background:#f59e0b; color:white" onclick="addProperty()">+ Add Property (Smith)</button>
        <button class="btn-action btn-add" onclick="addInvestment()">+ Add Investment Account</button>
        <button class="btn-action btn-run" onclick="runSim()">üöÄ Generate Strategy</button>
    </div>

    <div id="accountsContainer" class="grid"></div>
    <div id="output" class="table-wrap"></div>
</div>

<script>
function addProperty() {
    const div = document.createElement('div');
    div.className = 'card re-card';
    div.dataset.type = 'RE';
    div.innerHTML = `
        <button class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
        <strong>üè† Property & Smith Flywheel</strong>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <div><label>Home Value ($)</label><input type="number" class="reVal" value="800000"></div>
            <div><label>Mortgage Debt ($)</label><input type="number" class="reDebt" value="450000"></div>
            <div><label>Mortgage Rate (%)</label><input type="number" class="reRate" value="5.0"></div>
            <div><label>Smith Port Return (%)</label><input type="number" class="smRate" value="8.0"></div>
        </div>
    `;
    document.getElementById('accountsContainer').appendChild(div);
}

function addInvestment() {
    const div = document.createElement('div');
    div.className = 'card inv-card';
    div.dataset.type = 'INV';
    div.innerHTML = `
        <button class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
        <strong>üí∞ Investment Account</strong>
        <label>Account Name</label><input type="text" class="invName" value="Growth Portfolio">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <div><label>Initial Balance ($)</label><input type="number" class="invBal" value="150000"></div>
            <div><label>Annual Return (%)</label><input type="number" class="invRate" value="7.0"></div>
        </div>
        <div class="event-list">
            <strong>Targeted Withdrawals</strong>
            <div class="ev-container"></div>
            <button class="btn-action btn-add" style="font-size:10px; padding:3px 8px; margin-top:5px" onclick="addEventRow(this)">+ Add Withdrawal</button>
        </div>
    `;
    document.getElementById('accountsContainer').appendChild(div);
}

function addEventRow(btn) {
    const container = btn.previousElementSibling;
    const row = document.createElement('div');
    row.className = 'event-row';
    row.innerHTML = `
        <div><label>Age</label><input type="number" class="evAge" style="width:50px"></div>
        <div><label>Amount ($)</label><input type="number" class="evAmt" style="width:100px"></div>
        <button class="remove-btn" style="position:static; margin-left:5px" onclick="this.parentElement.remove()">√ó</button>
    `;
    container.appendChild(row);
}

function getSustainableWD(P, r, n, events, futureAge) {
    if (n <= 0) return P;
    let r_dec = r / 100;
    let pvOfEvents = 0;
    events.forEach(ev => {
        if (ev.age > futureAge && ev.age < (futureAge + n)) {
            pvOfEvents += ev.amt / Math.pow(1 + r_dec, ev.age - futureAge);
        }
    });
    let adjP = Math.max(0, P - pvOfEvents);
    if (r_dec === 0) return adjP / n;
    return adjP * (r_dec * Math.pow(1 + r_dec, n)) / (Math.pow(1 + r_dec, n) - 1);
}

function fmt(v) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v); }

function runSim() {
    const startAge = parseInt(document.getElementById('curAge').value);
    const endAge = parseInt(document.getElementById('tarAge').value);
    const accounts = document.querySelectorAll('.card');
    
    let processedAccounts = Array.from(accounts).map(acc => {
        if (acc.dataset.type === 'RE') {
            const mDebt = parseFloat(acc.querySelector('.reDebt').value);
            const mRateM = (parseFloat(acc.querySelector('.reRate').value) / 100) / 12;
            return {
                type: 'RE', hVal: parseFloat(acc.querySelector('.reVal').value),
                mDebt, mRateM, mPay: mDebt * (mRateM * Math.pow(1 + mRateM, 300)) / (Math.pow(1 + mRateM, 300) - 1),
                sBal: 0, sDebt: 0, smRate: parseFloat(acc.querySelector('.smRate').value)
            };
        } else {
            return {
                type: 'INV', name: acc.querySelector('.invName').value,
                bal: parseFloat(acc.querySelector('.invBal').value),
                rate: parseFloat(acc.querySelector('.invRate').value),
                events: Array.from(acc.querySelectorAll('.event-row')).map(r => ({
                    age: parseInt(r.querySelector('.evAge').value), amt: parseFloat(r.querySelector('.evAmt').value || 0)
                }))
            };
        }
    });

    let html = `<table><thead><tr><th>Age</th>`;
    processedAccounts.forEach(a => {
        if (a.type === 'RE') html += `<th colspan="5">Property (Smith Flywheel)</th>`;
        else html += `<th colspan="4">${a.name}</th>`;
    });
    html += `<th class="total-col">TOTAL NET WORTH</th></tr></thead><tbody>`;

    for (let age = startAge; age <= endAge; age++) {
        let totalNW = 0;
        html += `<tr><td><b>${age}</b></td>`;
        
        processedAccounts.forEach(a => {
            if (a.type === 'RE') {
                totalNW += (a.hVal - a.mDebt) + (a.sBal - a.sDebt);
                let interestEarned = a.sBal * (a.smRate / 1200) * 12;
                let shadowWD = getSustainableWD(a.sBal, a.smRate, endAge - age, [], age);
                html += `<td><span style="font-size:9px; color:#94a3b8">Equity</span><br>${fmt(a.hVal - a.mDebt)}</td>
                         <td><span style="font-size:9px; color:#94a3b8">Smith Port</span><br>${fmt(a.sBal)}</td>
                         <td class="interest-col"><span style="font-size:9px">Yr Return</span><br>${fmt(interestEarned)}</td>
                         <td class="shadow-wd"><span style="font-size:9px">Max WD</span><br>${fmt(shadowWD)}</td>
                         <td><span style="font-size:9px; color:#94a3b8">HELOC</span><br><span class="neg">${fmt(a.sDebt)}</span></td>`;
            } else {
                let withdrawal = a.events.filter(e => e.age === age).reduce((sum, e) => sum + e.amt, 0);
                if (withdrawal > a.bal) withdrawal = a.bal;
                totalNW += a.bal;
                let interestEarned = a.bal * (a.rate / 100);
                let shadowWD = getSustainableWD(a.bal, a.rate, endAge - age, a.events, age);
                html += `<td><span style="font-size:9px; color:#94a3b8">Balance</span><br>${fmt(a.bal)}</td>
                         <td class="interest-col"><span style="font-size:9px">Yr Return</span><br>${fmt(interestEarned)}</td>
                         <td class="shadow-wd"><span style="font-size:9px">Shadow Max WD</span><br>${fmt(shadowWD)}</td>
                         <td class="${withdrawal > 0 ? 'lump-hit' : ''}"><span style="font-size:9px">Action</span><br>${withdrawal > 0 ? 'OUT: ' + fmt(withdrawal) : '-'}</td>`;
                a.bal = (a.bal - withdrawal) * (1 + (a.rate/100));
            }
        });
        html += `<td class="total-col">${fmt(totalNW)}</td></tr>`;

        // Advance Smith/Property
        processedAccounts.filter(a => a.type === 'RE').forEach(a => {
            a.hVal *= 1.03;
            for (let m = 0; m < 12; m++) {
                if (a.mDebt > 0) {
                    let mInt = a.mDebt * a.mRateM;
                    let mPrin = Math.min(a.mDebt, a.mPay - mInt);
                    a.mDebt -= mPrin;
                    let growth = a.sBal * (a.smRate/1200);
                    a.mDebt = Math.max(0, a.mDebt - growth);
                    let totalP = mPrin + growth;
                    a.sDebt += totalP; a.sBal += totalP + (a.sBal * (a.smRate/1200));
                } else { a.sBal *= (1 + a.smRate/1200); }
            }
        });
    }
    document.getElementById('output').innerHTML = html + `</tbody></table>`;
}
window.onload = () => { addProperty(); addInvestment(); runSim(); };
</script>
</body>
</html>
